e = module.exports

class e.Semaphore
	blocks: null
	val: null
																															  
	constructor: (@val = 0) ->
		@blocks = []
																																																														    
	wait: (block) ->
		@val--
		@blocks.push block
		if @val >= 0
			@block()
																																																														    
	block: (signal_callback) ->
		if @blocks.length
			signal_callback_ = =>
				@val++
				signal_callback?()
			@blocks.shift() signal_callback_
		else
			signal_callback()
																																																														    
	signal: (next) ->
		# async
		delay = process?.nextTick or window.setTimeout 
		delay =>
			@val++
			@block next

class e.Mutex extends e.Semaphore
	constructor: ->
		super 1