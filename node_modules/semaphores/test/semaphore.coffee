semaphore = require '../semaphore'
[ Semaphore, Mutex ] = [ semaphore.Semaphore, semaphore.Mutex ]

require 'should'
log = console.log

describe 'Semaphore', ->
	it 'should sync instructions', (next) ->
		a1_flag = no
		b1_flag = no
		    
		a1 = -> a1_flag = yes
		b1 = ->
			a1_flag.should.be.ok
			b1_flag = yes
		    
		sem = new Semaphore
		    
		a = ->
			a1()
			sem.signal next
		b = ->
			sem.wait (next2) ->
				b1()
				next2()
	  
		b()
		a()
			      
	it 'should handle mutual exclusion', (next) ->
		mutex = new Mutex
		count = 0
		    
		a = ->
			mutex.wait ->
				count++
				# async
				process.nextTick ->
					count.should.equal 1
					mutex.signal()
		b = ->
			mutex.wait ->
				count++
				mutex.signal()
			      
		a()
		b()
		    