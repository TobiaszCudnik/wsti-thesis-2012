semaphore = require '../semaphore'
[ Semaphore, Mutex ] = [ semaphore.Semaphore, semaphore.Mutex ]

require 'should'
log = console.log

describe 'Semaphore', ->
	it 'should sync instructions order', (next) ->
		a1_flag = no
		b1_flag = no
																														    
		a1 = -> a1_flag = yes
		b1 = ->
			a1_flag.should.be.ok
			b1_flag = yes
																														    
		sem = new Semaphore
																														    
		a = ->
			a1()
			sem.signal next
		b = ->
			sem.wait (next) ->
				b1()
				next()
															  
		b()
		a()
																																													      
	it 'should handle mutual exclusion', (next) ->
		mutex = new Mutex
		count = 0
																														    
		a = ->
			mutex.wait (next) ->
				count++
				# async
				process.nextTick ->
					count.should.equal 1
					mutex.signal next
		b = ->
			mutex.wait ->
				count++
				mutex.signal next
																																													      
		a()
		b()
																																													      
	it 'should be async safe', (next) ->
		a1_flag = no
		b1_flag = no
																														    
		a1 = -> a1_flag = yes
		b1 = ->
			a1_flag.should.be.ok
			b1_flag = yes
																														    
		sem = new Semaphore
																														    
		a = ->
			a1()
			b1_flag.should.not.be.ok
			sem.signal ->
				b1_flag.should.be.ok
				next()
		b = ->
			sem.wait (next) ->
				b1()
				process.nextTick next
															  
		b()
		a()
		
		sem.wait next
		
	it 'should allow multi callback (barrier?)', ->
		no.should.be.ok																	    